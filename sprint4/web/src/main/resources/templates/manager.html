<!DOCTYPE html>
<html lang="en">
<head>
	<title>ParkingManagerService</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css">
	<style>

        /* Add a gray background color and some padding to the footer */
        footer {
            background-color: #e3f2f2;
            padding: 25px;
        }
		.mygrid {
			border-style: solid;
			border-width: 1px;
			border-color: lightblue;
		}
		html, body {
			height: 100%;
		}
	</style>
	<script th:inline="javascript">
		var TMAX = [[${TMAX}]];
	</script>
	<script>
		var temperatureModal = null;
		var trolleyErrorModal = null;
		var lastOutdoorAlarm = false;
		var lastTrolleyError = false;
		$(function () {
			temperatureModal = new bootstrap.Modal(document.getElementById('alertTemperature'));
			trolleyErrorModal = new bootstrap.Modal(document.getElementById('alertTrolleyError'));
			$("#divStopTrolley").prop("title", "You can stop the trolley only if the temperature is over "+TMAX);
			$("#infoTemperature").prop("title", "The temperature inside the parking area. The maximum recommended value is "+TMAX);
			$("#infoFanState").prop("title", "Current state of the fan. Can be ON or OFF. It activates automatically when the temperature is over "+TMAX);
			$("#infoTrolleyState").prop("title", "Current state of the transport trolley. Can be IDLE, WORKING, STOPPED");
			$("#stopTrolley,#startTrolley").on("click", function (e) {
				let state = (e.target.id === "stopTrolley") ? "stopped" : "working";
				$.post("/api/manager/setTrolley/"+state, function (response) {
					let data = $.parseJSON(response);
					if(data.ok) {
						setTimeout(update, 1000);
					} else {
						alert("Error: " + data.errorMessage);
					}
				});
			});
			//Set tooltip
			var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
			var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
				return new bootstrap.Tooltip(tooltipTriggerEl)
			})
		});
		updateRecursive();
		function update() {
			$.getJSON("/api/manager/status", function (data) {
				console.log(data);
				if(data.trolleyState === "STOPPED") {
					$("#stopTrolley").prop("disabled", true);
					$("#startTrolley").prop("disabled", false);
				} else {
					$("#stopTrolley").prop("disabled", data.sensors.temperature.measure <= TMAX);
					$('#divStopTrolley').tooltip(data.sensors.temperature.measure > TMAX ? 'disable' : 'enable');
					$("#startTrolley").prop("disabled", true);
				}
				$("#fanState").text(data.fanState);
				$("#trolleyState").text(data.trolleyState);
				$("#lastUpdate").text(getTime(data.sensors.temperature.time));
				$("#temperatureState").text(data.sensors.temperature.measure);
				if(data.sensors.temperature.measure > TMAX)
					$("#temperatureState").css("color", "red");
				else
					$("#temperatureState").css("color", "black");
				//$("#temperatureStateTime").text(getTime(data.sensors.temperature.time));
				if(data.outdoorAlarm && !lastOutdoorAlarm) {
					$("#dtfree").show();
					temperatureModal.show();
					lastOutdoorAlarm = true;
				} else if(!data.outdoorAlarm && lastOutdoorAlarm) {
					$("#dtfree").hide();
					temperatureModal.hide();
					lastOutdoorAlarm = false;
				}

				if(data.trolleyError && !lastTrolleyError) {
					$("#trolleyError").show();
					trolleyErrorModal.show();
					lastTrolleyError = true;
					$("#trolleyErrorNotification")[0].play();
				} else if(!data.trolleyError && lastTrolleyError) {
					$("#trolleyError").hide();
					trolleyErrorModal.hide();
					lastTrolleyError = false;
				}
			});
		}
		function updateRecursive() {
			update();
			setTimeout(updateRecursive, 10000);
		}
		function getTime(timestamp) {
			let dateObj = new Date(timestamp * 1000);
			let hour = dateObj.getHours();
			let min = dateObj.getMinutes();
			let sec = dateObj.getSeconds();
			return "" + (hour >= 10 ? hour : "0" + hour) + ":" + (min >= 10 ? min : "0" + min) + ":" + (sec >= 10 ? sec : "0" + sec);
		}
	</script>
</head>
<body>

<div class="p-7 mb-4 bg-light rounded-3 text-center">
	<div class="container-fluid py-5">
		<h1 class="display-4 fw-bold">ParkManagerService</h1>
		<p class="fs-4">by Musarella & Tripi</p>
	</div>
</div>



<div class="container text-center">
	<div class="row">
		<div class="col">
			<img src="images/parkingArea.jpg" class="img-responsive" style="width:50%; max-width: 220px; min-width: 100px;" alt="Image">
		</div>
	</div>

	<div class="row" style="padding-bottom: 60px">
		<div class="col">
			<h3>Manager view</h3>
		</div>
	</div>

	<div class="row" id="temperature">
		<div class="col mygrid">
			Current temperature <i id="infoTemperature" class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top"></i>
		</div>
		<div class="col mygrid">
			<span id="temperatureState"></span>Â°C
<!--			<br><span id="temperatureStateTime"></span>-->
		</div>
	</div>

	<div class="row" id="fan">
		<div class="col mygrid">
			Fan state <i id="infoFanState" class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top"></i>
		</div>
		<div class="col mygrid">
			<span id="fanState"></span>
			<!-- anche last update -->
		</div>
	</div>
	<div class="row" id="trolley">
		<div class="col mygrid">
			Trolley state <i id="infoTrolleyState" class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="top"></i>
		</div>
		<div class="col mygrid">
			<span id="trolleyState"></span>
		</div>
	</div>
	<div class="row">
		<div class="col mygrid">
			Last update
		</div>
		<div class="col mygrid">
			<span id="lastUpdate"></span>
		</div>
	</div>

	<div class="row" id="dtfree" style="display: none; color: red; font-weight: bold">
		<div class="col">
			Alert OUTDOOR ON
		</div>
		<div class="col">
			CHECK IMMEDIATELY!!!!
		</div>
	</div>

	<div class="row" id="trolleyError" style="display: none; color: red; font-weight: bold">
		<div class="col">
			TROLLEY ERROR
		</div>
		<div class="col">
			CHECK IMMEDIATELY!!!!
		</div>
	</div>
	<audio id="trolleyErrorNotification">
		<source src="Airplane-Beep.mp3" type="audio/mpeg">
	</audio>
	<div class="row" style="padding-top: 25px">
		<div class="col">
			<span id="divStopTrolley" data-bs-toggle="tooltip" data-bs-placement="top">
				<button type="button" class="btn btn-primary" id="stopTrolley" data-action="" disabled="disabled">Stop trolley</button>
			</span>
		</div>
		<div class="col">
			<button type="button" class="btn btn-primary" id="startTrolley" data-action="" disabled="disabled">Start trolley</button>
		</div>
	</div>
</div><br>


<footer class="container-fluid">
	<p>Project for the course Ingegneria dei Sistemi Software M, UNIBO</p>
	<p>By Alessandro Musarella <a style="color: grey" href="mailto:alessandro.musarella@studio.unibo.it">alessandro.musarella@studio.unibo.it</a><br>
		By Giulio Tripi <a style="color: grey" href="mailto:giulio.tripi@studio.unibo.it">giulio.tripi@studio.unibo.it</a><br>
		GitHub: <a style="color: grey" href="https://github.com/giuliotripi/ParkManagerService">https://github.com/giuliotripi/ParkManagerService</a></p>
</footer>

<div class="modal" tabindex="-1" id="alertTemperature">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Outdoor alarm</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<p>A car was left in front of OUTDOOR for a time greater than DTFREE.</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>

<div class="modal" tabindex="-1" id="alertTrolleyError">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Trolley error alarm</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<p>The trolley encountered an unexpected obstacle and need a manual assistance. Please finish his
				action manually and bring it back at home with direction down and ONLY after click on resume button.</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
</body>
</html>
