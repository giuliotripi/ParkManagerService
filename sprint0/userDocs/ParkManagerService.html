<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
	<!--
	<link rel="stylesheet" type="text/css" href="../css/issStyle1.css">
	<script type="text/javascript" src="../css/issStyle.js"></script>
	-->
	<style type="text/css">
        body {
            margin-left: 30px;
            margin-right: 30px;
        }

        /*P {
			font-family: Tahoma;
			font-size: 10pt;
		}*/

        a, a:visited, a:active, a:link, a:hover {
            text-decoration: underline;
            color: #545454;
            background-color: transparent;
            font-size: 93%;
        }

        a:hover {
            background-color: #cccccc;
        }


        hr {
            clear: both;
            height: 1px;
            color: #242424;
            background-color: transparent;
        }

        h1, h2, h3 {
            color: #242424;
            clear: left;
            font: 100% Tahoma, Helvetica, Arial, sans-serif;
            margin-bottom: 0.5em;
            padding-top: 0.5em;
            border-radius: 10px;
            padding: 5px;
        }

        top {
            width: 100%;
        }


        #i {
            color: #ff1010;
        }

        tt {
            font-family: "Arial";
            font-size: 90%;
            color: #006600;
        }

        em {
            font-family: "Arial";
            font-size: 80%;
            font-weight: bold;
            border-style: solid;
            border-color: #abe876;
            color: #1632cc;
        }

        bc {
            font-family: "Arial";
            font-size: 90%;
            font-weight: bold;
            color: #990000;
            background-color: #fcf8c7;
        }

        ks {
            font-family: "Arial";
            font-weight: bold;
            color: #0000CD;
            font-size: 90%;
        }

        kc {
            font-family: "Arial";
            font-weight: bold;
            color: #008000;
            font-size: 90%;
        }

        pre {
            font-family: "Consolas";
            font-size: 85%;
            background-color: #f5f5f5;
            border: 1.5px solid silver;
            padding: 5px;
        }

        m {
            font-family: "Helvetica";
            line-height: 100%;
            font-size: 75%;
        }

        div.body {

            font-size: 18px;
        }

        k {
            color: #990000;
            font-weight: bold;
        }

        h1 {
            font-size: 150%;
            background-color: #b2c0ff;
            padding: 10px;
        }

        h2 {
            background-color: #9ed8ff;
            font-size: 130%;
        }

        h3 {
            background-color: #e6ccff;
            font-size: 100%;
        }

        h4 {
            background-color: #ccffcc;
            font-size: 100%;
            width: 95%;
            border-radius: 5px;
            padding: 2px;
        }

        h5 {
            background-color: #d5ffb0;
            font-size: 100%;

        }

        div.req {
            background-color: #d9ffb3;
            font-size: 18px;
            width: 700px;
            border: 3px solid green;
            padding: 15px;
            margin: 10px;
        }

        div.remark {
            background-color: #E3F2FD;
            border: 1.5px solid #d5f2ed;
            padding: 15px;
            margin: 10px;
            border-radius: 25px;
        }

        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
        }

        ol, ul, li {
            margin: 0;
            margin-left: 10px;
            padding: 0;
            padding-bottom: 5px;
        }

        table, th, td {
            border: 1px solid black;
        }

        img {
            border: 1.5px solid #d5f2ed

        }

        a, a:visited, a:active, a:link, a:hover {
            text-decoration: underline;
            color: #545454;
            background-color: transparent;
        }

        div.wrapdesc {
            width: 90%;
            margin: auto;
        }

        div.imagedesc {
            width: 85%;
            margin: auto;
        }
        ol.custom {
            counter-reset: number;
        }
        ol.custom > li {
            list-style: none;
            counter-increment: number;
        }
        ol.custom.functional > li::before {
            content: "F" counter(number) ".";
            position: relative;
            left:-5px;
            color: #1632cc;
        }
        ol.custom.nonfunctional > li::before {
            content: "NF" counter(number) ".";
            position: relative;
            left:-5px;
            color: #1632cc;
        }
	</style>

	<title>ParkManagerService</title>
	<link rel="icon" href="img/favicon.png">
</head>

<body>
<div id="top">
	<h1>ESAME DI INGEGNERIA DEI SISTEMI SOFTWARE <font size="5"></font></h1>
</div>

<div class="body">
	<h2>Introduction</h2>


	<h2>Requirements</h2>
	<div class="remark">
		The document written by the customer with the requirements can be found <a href="TFBO21ParkingISS.pdf">here</a>.
	</div>


	<h2>Requirement analysis</h2>
	<div class="remark">
		<h3>Dictionary</h3>
		<h4>Nouns</h4>
		<ul>
			<li><ks>ParkManagerService</ks>: The software system which will implement the required automation functions;</li>
			<li><ks>DDR robot</ks>: Differential Drive Robot. Has the form of a square of side length RD (<a href="https://htmlpreview.github.io/?https://github.com/anatali/issLab2021/blob/main/it.unibo.qak21.basicrobot/userDocs/LabNanoRobot.html">link</a>)</li>
			<li><ks>transport trolley</ks>: A DDR robot which is used to move cars from the INDOOR to the selected
				parking-slot. It can be in three different states: <k>idle</k>, the robot is waiting for the next command,
				<k>working</k>, the robot is moving around the parking-area, executing a command, <k>stopped</k>, the robot
				is stopped by the <ks>parking-manager</ks>;</li>
			<li><ks>home</ks>: Starting position for the robot, located in the top-left corner of the environment. When the
				robot completes a request, and there are no further instruction, it will return in this position;</li>
			<li><ks>parking-area</ks>: Empty environment outside which the robot cannot go. It includes INDOOR, INDOOR-area,
				OUTDOOR, OUTDOOR-area, parking-slots, thermometer and a fan;</li>
			<li><ks>INDOOR</ks>: Cars use this gate to enter the parking-area;</li>
			<li><ks>INDOOR-area</ks>: The transport trolley positions itself in this location to pick the car parked in
				front of the INDOOR. It is located inside the parking area;</li>
			<li><ks>weightsensor</ks>: Sensor to measure the weight of the car, located in front of the INDOOR;</li>
			<li><ks>OUTDOOR</ks>: Cars uses this gate to exit from the parking-area;</li>
			<li><ks>OUTDOOR-area</ks>: The transport trolley positions itself in this location to leave the car
				just outside the OUTDOOR. Drivers pick them up there.
				It is located inside the parking area;</li>
			<li><ks>outsonar</ks>: Sensor that detects cars outside the OUTDOOR;</li>
			<li><ks>parking-slots</ks>: Dedicated slots inside the parking area where cars are left by the transport
				trolley. There are 6 parking-slots;</li>
			<li><ks>thermometer</ks>: Sensor used to measure the temperature inside the parking-area;</li>
			<li><ks>fan</ks>: A fan used to reduce the temperature inside the parking-area. It can be manually activated
				by the parking manager, or it can activate automatically. It can be either on or off;</li>
			<li><ks>map</ks>: Schematic representation of the parking-area, made by a grid of squares of side length RD;</li>
			<li><ks>fixed obstacles</ks>: Immovable objects that the robot cannot traverse;</li>
			<li><ks>enterRequest</ks>: The request made by the client to the ParkManagerService to book a parking-slot;</li>
			<li><ks>carEnter</ks>: The request made by the client to the ParkManagerService after enterRequest when he parks
				his car in front of the INDOOR and press the CARENTER button;</li>
			<li><ks>pickUp</ks>: The request made by the client to the ParkManagerService when he wants to pick up
				his car. This request can be made after carEnter;</li>
			<li><ks>parking-manager</ks>: Person in charge of the parking-area, who supervises the state and handles
				critical situations;</li>
			<li><ks>client</ks>: Person using services of the parking-area. In particular, he will leave and pickup the car;</li>
			<li><ks>ParkServiceGUI</ks>: GUI for parking clients to leave and pick up cars. It can be accessed by the client
				by using their own personal device;</li>
			<li><ks>ParkServiceStatusGUI</ks>: GUI for the parking-manager to manage some aspects of the parking area;</li>
			<li><ks>SLOTNUM</ks>: Id of the parking slot given to the client, representing the location where the car will
				be placed by transport trolley. If equal to 0, no parking slots are available</li>
			<li><ks>TOKENID</ks>: Sequence of characters. The characters should be generated in a manner that:
				<ul>
					<li>Two cars cannot have the same TOKENID while they are in the parking area</li>
					<li>It is impossible to guess the generated ID (cryptographically secure random)</li>
					<li>The generated ID must have a significative number of character</li>
				</ul></li>
			<li><ks>Alarm</ks> (to the parking manager): notification for the parking manager to signal if the OUTDOOR-area
				is not freed within DTFREE interval of time;</li>
			<li><ks>current state</ks>: Collection of the following information:
				<ul>
					<li>current temperature inside the parking-area;</li>
					<li>current state of the fan (<k>on</k> or <k>off</k>);</li>
					<li>current state of the transport trolley (<k>idle</k>, <k>working</k> or <k>stopped</k>);</li>
				</ul></li>
		</ul>
		<h4>Verbs</h4>
		<ul>
			<li><ks>leave the car</ks>: after receiving the SLOTNUM, the client leaves the car in the INDOOR-area and
				presses the CARENTER button on the ParkServiceGUI. He will then receive the unique TOKENID;</li>
			<li><ks>pick up the car</ks>: the client uses the ParkServiceGUI to request the pick up, by sending the TOKENID
				previously received. After the car is moved to the OUTDOOR-area by the robot, the client takes the car and
				frees the area within DTFREE interval of time;</li>
			<li><ks>start the fan</ks>: when the current temperature inside the parking-area exceeds TMAX, the system
				starts the fan automatically;</li>
			<li><ks>stop the fan</ks>: when the current temperature goes below TMAX, the system stops the fan automatically;</li>
			<li><ks>stop the robot</ks>: when the current temperature inside the parking-area exceeds TMAX, the
				parking-manager stops the robot, blocking any successive move until he starts the robot again;</li>
			<li><ks>start the robot</ks>: after the parking-manager stops the robot, it remains stopped until restarted
				by the parking-manager;</li>
		</ul>

		<h3>Additional requirements and details</h3>
		The following requirements are the result of further clarification with the customer: <br><br>
		<ul>
			<li>The fan is automatically activated/deactivated by ParkManagerService. The parking manager cannot overtake
				control of it;</li>
			<li>The transport trolley cannot be stopped if TA <= TMAX;</li>
			<li>It is impossible that a user reaches the INDOOR without having reserved a parking slot from the GUI;</li>
			<li>It is impossible that a user parks in the INDOOR area and does not press the CARENTER button;</li>
			<li>It is impossible that a user notify his interest in entering his auto in the parking-area and later changes
				his mind and does not park in the parking area;</li>
			<li>It is impossible that a customer reserves a parking slot and do not show up at the parking area;</li>
			<li>When client try to make an enterRequest, carEnter or pickUp, if the transport trolley is stopped,
				the client should see an error message;</li>
			<li>When parking manager stops the transport trolley, the transport trolley won't accept further commands
				but finishes the move it was doing (e.g. if it is going to the INDOOR area, it reaches the INDOOR and
				then stops accepting other requests);</li>
			<li>When the parking manager starts the transport trolley, it should continue the move it was doing before it
				was stopped;</li>
			<li>Temperature is in Celsius;</li>
			<li>TMAX and DTFREE will be placed in a configuration file accessible by the application;</li>
		</ul>

		<h4>Map of the parking-area</h4>
		The customer provides a
		<a href="https://github.com/anatali/issLab2021/blob/main/it.unibo.kotlinSupports/app/src/main/kotlin/mapRoomKotlin">library</a>
		in Kotlin to represent the map of the parking-area.<br>
		Below there is a representation of the parking area, the <k>X</k> represent the obstacles which the robot cannot
		cross.

		<table>
			<tr>
				<td>
					<img src="img/map.png" style="max-width: 95%" alt="Position of sensors in map">
				</td>
				<td>
					<img src="img/map2.png" style="max-width: 95%" alt="Non traversable positions in map">
				</td>
			</tr>
		</table>
		<h3>Additional user stories</h3>
		In order to explain better some edge cases, some examples were made with the customer, reported below.<br>
		<ks>Multiple users using the application</ks><br>
		<ol>
			<li>Client1 notify his interest in entering his auto in the parking-area.</li>
			<li>Client2 submit the request to pick up his car but receive a notice message from the
				application requesting to wait. The request will be served when the previous ends.</li>
			<li>Afterwards, Client3 wants to enter his auto in the parking-area but receive a notice message from the
				application requesting to wait. The request will be served when the previous ends.</li>
			<li>Client2 and Client3 remain waiting.</li>
			<li>Client1 finish his parking phase.</li>
			<li>Without further interaction by Client2, ParkManagerService fulfills his request.</li>
			<li>Without further interaction by Client3, ParkManagerService fulfills his request.</li>
		</ol>
		<ks>User tries to enter while the trolley is stopped</ks><br>
		<ol>
			<li>The temperature goes above TMAX</li>
			<li>The parking-manager stops the transport trolley</li>
			<li>Client1 notify his interest in entering his auto in the parking-area or press CARENTER. Client1 receive
				a notice message from the application stating that the system is temporary unavailable.</li>
			<li>Client2 submit the request to pick up his car but receive a notice message from the application stating
				that the system is temporary unavailable.</li>
			<li>The parking-manager restart the trolley as soon as the temperature goes below TMAX</li>
			<li>Client2 makes again his request and ParkManagerService fulfills it.</li>
			<li>Client1 tries to notify again his interest in entering his auto again as if it was just arrived, without
				record of his waiting.</li>
		</ol>
		<h3>Risk analysis</h3>

		There are some risks involving the management of a physical area and storing valuable vehicles, discussed
		in the tables below.

		<h4>Table of Goods Evaluation</h4>
		<table>
			<tr>
				<th>Good</th>
				<th>Value</th>
				<th>Exposure</th>
			</tr>
			<tr>
				<td>System</td>
				<td>High</td>
				<td>High. Financial and image loss, System restoration cost. Parking unable to work</td>
			</tr>
			<tr>
				<td>TOKENID</td>
				<td>High</td>
				<td>High. Could be used to steal a car. Financial and image loss.</td>
			</tr>
			<tr>
				<td>Transport trolley</td>
				<td>High</td>
				<td>High. Could be used to steal or damage a car (bumping into it). Financial and image loss.</td>
			</tr>
			<tr>
				<td>Faking temperature or stopping fan</td>
				<td>Medium</td>
				<td>Medium. Could result in a too hot environment that could cause the devices to fail</td>
			</tr>
			<tr>
				<td>Status of the parking area</td>
				<td>Low</td>
				<td>Low. No useful data from those information</td>
			</tr>
		</table>

		<h4>Table of threats and checks</h4>
		<table>
			<tr>
				<th>Threat</th>
				<th>Probability</th>
				<th>Checks</th>
				<th>Feasibility</th>
			</tr>
			<tr>
				<td rowspan="2">Stole or guess of TOKENID</td>
				<td rowspan="2">Low. It is quite long and generated as a cryptographically secure pseudo-random string</td>
				<td>Limitation of the number of wrong TOKENID submitted</td>
				<td>Low implementative cost</td>
			</tr>
			<tr>
				<td>Operations log</td>
				<td>Low implementative cost</td>
			</tr>
			<tr>
				<td rowspan="2">Interception of communications between client and server</td>
				<td rowspan="2">High. The system is Client/Server and the connection are done in insecure networks.</td>
				<td>Asymmetric key communication encryption</td>
				<td>Low implementative cost</td>
			</tr>
			<tr>
				<td>Operations log</td>
				<td>Low implementative cost</td>
			</tr>
			<tr>
				<td rowspan="2">Control of the transport trolley</td>
				<td rowspan="2">Medium. No encryption on the communication between it and the Service. No authentication to
					submit commands</td>
				<td>Add encryption and authentication</td>
				<td>Medium. Needs to change the software provided by the customer</td>
			</tr>
			<tr>
				<td>Use a secure network for the communication</td>
				<td>Hardware cost for all the network devices that cannot be shared with other devices</td>
			</tr>
		</table>

		<h4>Security Technology Analysis</h4>

		<table>
			<tr>
				<th>Technology</th>
				<th>Vulnerability</th>
			</tr>
			<tr>
				<td>Use of TOKENID</td>
				<td>
					<ul>
						<li>User reveals his TOKEN to third parties</li>
						<li>TOKEN gets guessed from attackers with a bruteforce attack</li>
					</ul>
				</td>
			</tr>
			<tr>
				<td>Communication encryption between Service and users</td>
				<td><ul>
					<li>Clients connects to a Server that proposes to use an insecure connection</li>
					<li>Clients connects to a server that does not have a certificate that is considered reliable</li>
					<li>The Server supports insecure or obsolete encryption protocols (e.g. less than TLSv1.2).</li>
					<li>The Server uses keys with a low number of bits.</li>
					<li>The Server's private key is stolen.</li>
				</ul></td>
			</tr>
			<tr>
				<td>Client/Server architecture</td>
				<td>
					<ul>
						<li>Dos/DDos attack</li>
						<li>Man in the Middle</li>
						<li>Communication Sniffing</li>
					</ul>
				</td>
			</tr>
		</table>

		<h3>List of requirements</h3>
		<h4>Functional requirements</h4>
		<ol class="custom functional">
			<li>The client can book a parking slot through ParkServiceGUI</li>
			<li>The system sends the client an id of the parking-slot if there are slots available, otherwise it sends 0</li>
			<li>The client notifies the ParkManagerService when he leaves the car in front of the INDOOR</li>
			<li>The system can transport the cars from the INDOOR to the parking slots, and from the parking slots to the
				OUTDOOR by sending command to a transport trolley</li>
			<li>The system should provide a unique identifier to the client (TOKENID), in order to retrieve the car later</li>
			<li>The system must understand if the client's car is not in front of the INDOOR during F3</li>
			<li>The system can accept the request of a client to park in there only if there is at least one parking-slot
				available, the weigthsensor don't detect a car in front of the INDOOR, and the transport trolley is either
				at home or working</li>
			<li>When client try to make an enterRequest, carEnter or pickUp, if the transport trolley is stopped, the
				client should see an error message</li>
			<li>The client can pick up the car by sending the TOKENID through ParkServiceGUI</li>
			<li>The system must infer the correct parking-slot from the corresponding TOKENID</li>
			<li>The system can accept the request of a client to pick up the car only if the TOKENID is valid, the outsonar
				don't detect a car in front of the OUTDOOR, and the transport trolley is either at home or working</li>
			<li>The parking manager can see the current state of the parking area through ParkServiceStatusGUI</li>
			<li>The parking manager should be able to stop the transport trolley when TA > TMAX through ParkServiceStatusGUI</li>
			<li>The parking manager should be able to start the transport trolley when it is stopped through ParkServiceStatusGUI</li>
			<li>ParkManagerService should start the fan when TA > TMAX and stop it when TA <= TMAX</li>
			<li>ParkManagerService should notify the parking manager when the OUTDOOR is not cleaned within DTFREE
				interval of time</li>
			<li>The trolley must go back to home when there are no more requests available</li>
			<li>The trolley should not walk over parking-slots or obstacles</li>
			<li>Creation of a log to track action done in the system and exchanged messages</li>
			<li>Automatic mechanism of log analysis</li>
		</ol>

		<h4>Non-functional requirements</h4>
		<ol class="custom nonfunctional">
			<li>The TOKENID generated must be secure and not easy to guess</li>
			<li>It should be possible to swap between real sensor and simulated mock-objects with ease</li>
			<li>Data stored and exchanged must be protected</li>
		</ol>

		<h3>System architecture</h3>
		From the requirements given by the customer, we can deduce the structure of the system. It is a distributed
		system, with different devices communicating with each other in different places of the parking area. More
		specifically, we have:
		<ul>
			<li>The client devices to interact with the ParkServiceGUI;</li>
			<li>The parking manager device to interact with the ParkServiceStatusGUI;</li>
			<li>The ParkManagerService core;</li>
			<li>The transport trolley;</li>
			<li>The three sensors and the fan.</li>
		</ul>

		<h4>Transport Trolley</h4>
		The transport trolley is the core entity of the project, as it is responsible for transporting the cars around
		the parking. The customer has provided us the model and the code of a <a href="https://htmlpreview.github.io/?https://github.com/anatali/issLab2021/blob/main/it.unibo.qak21.basicrobot/userDocs/basicrobot2021.html">basicrobot</a>.
		The basicrobot is able to execute basic move commands, is a CoAP-observable resource, and can interact with both a
		physical or virtual robot, simply by changing a configuration file. It is modelled as an actor. Because we are in
		a distributed system, and most likely the transport trolley will be on a separate node, the transport trolley
		will be modelled as an active entity, an actor, that wraps the basicrobot. The following graphs show the
		interaction between the transport trolley and the ParkManagerService. These basic interactions can be deduced
		from the requirements. Further interaction will be added if needed in the problem analysis. Since we have clarified
		with the customer that the requests fot the moves are not handled in parallel, we have represented them as
		synchronous request, while the stop and resume command are dispatch.

		<br>

		<img style="max-width: 100%" src="img/trolley-interaction.png" alt="trolley interaction">

		<br>

		In addition, is available an
		<a href="https://htmlpreview.github.io/?https://github.com/anatali/issLab2021/blob/master/it.unibo.virtualRobot2020/userDocs/VirtualRobot2021.html">API documentation</a>
		to communicate with a virtual robot to simulate the moves of a real robot in a virtual environment.

		<br>
		As mentioned in the requirements, the transport trolley can be in three different states: <k>idle</k>, <k>working</k>
		or <k>stopped</k>. The robot is <k>idle</k> if it is at home or returning home(moveToHome), after completing all
		its requests. When the robot receives a new request (moveToIn, moveToSlotIn, moveToSlotOut, moveToOut), it
		switches to the <k>working</k> state. If the robot is in the <k>working</k> state, and receives a new request
		(moveToIn, moveToSlotIn, moveToSlotOut, moveToOut), it will serve that request after finishing the current one,
		remaining in the <k>working</k> state.
		Finally, the robot enter and exit the <k>stopped</k> state when receiving the stop and resume command.<br>

		<img style="max-width: 100%" src="img/trolley-state.png" alt="Trolley state">

		<h4>Other devices</h4>
		We have different devices in the parking area: weight-sensor, outsonar, thermometer, fan.

		As they will all be on different nodes inside the parking area, we will also model these devices as actors.

		The customer has already provided us the code and the model of both
		<a href="https://htmlpreview.github.io/?https://github.com/anatali/issLab2021/blob/main/it.unibo.sonarAsResource/userDocs/LabSonarAsResource.html">sonar device</a>
		and <a href="https://htmlpreview.github.io/?https://github.com/anatali/issLab2021/blob/main/it.unibo.rasp2021/resources/rasp/sonar/SonarAlone.c">SonarAlone.c</a>.
		The former is modelled as an actor, which is capable of emitting event and sending dispatch, while the latter
		is a simple program that read and writes as output the distance measured by the sensor.

		For the weight-sensor, the thermometer and the fan, the customer did not provide us with any code or strict
		requirements. The weight-sensor by requirements doesn't have to communicate the weight the car, but acts only as
		a detection device. The accuracy of the thermometer is one degree.
		The interaction between these devices and the ParkManagerService will be defined in the Problem Analysis.

		<!-- Furthermore, the weight sensor, the outsonar and the thermometer must be also capable of sending events, so by
		making them as active entities, we won't have the need to interact with polling. The following graphs show the
		interaction between these devices and the ParkManagerService. -->

		<img style="max-width: 100%" src="img/sensor-interaction-requirements.png" alt="sensor interaction"><br>

		<!-- codice già fornito per il sonar, è un oggetto, incapsularlo in un attore -->

		<h3>Logical Architecture</h3>
		The following image shows all the devices in the parking area, and how they are connected to each other.

		<img style="max-width: 100%" src="img/logical-architecture-requirements.png" alt="logical architecture">

		For the sake of completeness, we also provided a machine-readable <a href="../src/model-requirements.qak">model</a>,
		which highlights only the core aspects of the system, namely, the park phase and the pick-up phase.
	</div>


	<h2>Problem analysis</h2>
	<div class="remark">
		<h3>Devices</h3>
		It is now important to analyze how the devices are made and how they communicate with the ParkManagerService.
		We already discussed that the devices are physically distant from each others and the Service, so they should
		communicate with message-passing. More information on the hardware of the single components are reported below:
		<ul>
			<li><ks>thermometer</ks>: a DS18B20 device is a low-cost sensor to measure the temperature, connected via
				cable.
			</li>
			<li><ks>outsonar</ks>: The sensor is connected to the software via a cable and supports platforms like Arduino and Raspberry Pi.</li>
			<li><ks>fan</ks>: can be controlled simply giving or removing power from it. A relay could be used to switch
				it on and off from a computer</li>
		</ul>

		<h4>Communication between devices</h4>
		Given the Requirements analysis it is now possible to define the interaction between all the devices in the System.<br>

		<ul>
			<li><ks>fan</ks>: accepts only start/stop commands</li>
			<li><ks>outsonar</ks>: the customer provided us, besides the SonarAlone.c program, even some applications
				that sends events for every reading or every bunch of readings. To avoid unnecessary traffic on the net it
				is better to re-implement it in such a way that only send events when a car arrives or leaves.
				To do so, it could read a threshold value from a configuration file.</li>
			<li><ks>weight sensor & thermometer</ks>: similarly to the outsonar, it is better to embed these sensors in
				actors, so that they only send events when the value exceeds a certain threshold value. This value
				could be set using  a configuration file.
			</li>
		</ul>
		Since the behaviour of the three sensors is conceptually the same (they read a value, and the have to communicate
		it to the parkingService), the actors that encapsulate them will have almost the same structure, the only thing
		changing will be the program called for the reading.<br>

		<img style="max-width: 100%" src="img/sensor-interaction.png" alt="Sensor interaction">
		<br>
		There are some possible protocols for communicating between the different devices. The most relevant are:<br>
		<ul>
			<li><ks>CoAP</ks>: (a)synchronous one-to-one communication protocol based on a request-response
				model, has even some implementations that runs over DTLS, even if it is not as popular as webSockets on TLS.</li>
			<li><ks>MQTT</ks>: asynchronous publish-subscribe model with a many-to-many mindset, not required
				in this scenario</li>
			<li><ks>HTTP</ks>: it is quite heavy and unidirectional, but could be used for example for the fan, that
				should only receive commands and reply with an ok/non-ok message. On the other hand, in this way, to provide a layer of encryption, the fan
				should have an HTTP server and a TLS certificate that should be renewed when expired, complicating the maintenance.</li>
			<li><ks>WebSockets</ks>: lighter than HTTP but still heavy. Bi-directional and supports encryption with
				minimum effort. Because of his bi-directionality, only the Service should act as a server and the other
				devices could easily connect to it and exchange messages, requiring only one server and one TLS certificate.</li>
		</ul>
		While for public network encryption is mandatory, it is true that only the Service has to be exposed to internet,
		and it could communicate with the devices over a private network non-accessible by other devices, thus not requiring encryption.<br>
		In this case, the Service has to be located in the neighborhood of all the sensors, while with encryption it
		could be located everywhere and provide his services with a reduced risk of in-place maintenance.<br>
		At this point, the two main alternatives are CoAP and WebSockets. We will use CoAP because it is lighter and
		already integrated with the modelling language qak provided by the customer.
		<br><br>

		<h3>Planner</h3>
		In order to move the transport trolley around the map, it is necessary to plan all the moves needed for the
		transport to reach his destination.<br>

		The customer provided us a planner that uses the map referenced in the requirement analysis to provide a list
		of moves that the transport trolley has to do in order to reach the given destination.<br>

		The code is available <a href="https://github.com/anatali/issLab2021/tree/main/it.unibo.planner20">at this location</a>.
		The class <code style="font-size: 15px">plannerUtil</code> is located in
		<code style="font-size: 15px">itunibo.planner</code> package and can be imported in the project adding
		<a href="https://github.com/anatali/issLab2021/blob/main/unibolibs/IssActorKotlinRobotSupport-2.0.jar">
			<code style="font-size: 15px">IssActorKotlinRobotSupport-2.0</code></a>
		as requirement in the gradle build file.

		<h3>GUI interaction</h3>

		<img style="max-width: 100%" src="img/gui-interaction.png" alt="GUI interaction"><br>

		The two GUIs are represented in a different context because the ParkManagerService could expose some APIs
		completely independent of the GUIs, that can be served even by different machine or installed as mobile apps
		on users' devices.
		In the model above, the requests without an explicit reply imply a simple acknowledgement message.
		<br>
		It is also available an executable model of the system written in <a href="../src/model.qak">qak language</a>.

	</div>


	<h2>Test plans</h2>
	<div class="remark">

		<h3>Unit tests</h3>

		The test plans listed here are done in
		<a href="../../sprint1/test/eu/musarellatripi/test/TestPlan0.kt">TestPlan0</a> and in
		<a href="../../sprint2/core/test/eu/musarellatripi/test/TestPlan2.kt">TestPlan2</a>.

		<table style="width:100%" border="1">

			<!-- TEST ENTER REQUEST (F1, F2, F7, F8) -->

			<tr>
				<td>
					<h4>testClientEnterRequest</h4>
					The client requests a slot and there is one slot available, the weigthsensor don't detect a car in <!-- così (quindi bisogna controllare?) o precondizione INDOOR area is free -->
					front of the INDOOR, and the transport trolley is either at home or working. (F1, F2, F7)
					<br/><b>Conditions</b>
					<ul>
						<li>The client receives 1 <= SLOTNUM <= 6</li>
						<li>The client can move on with the booking</li>
						<li>The selected slot becomes unavailable until further notice</li>
					</ul>
				</td>
			</tr>

			<tr>
				<td>
					<h4>testClientEnterRequestNoSlotsFree</h4>
					The client requests a slot but there is not a free slot. (F1, F2, F7)
					<br/><b>Conditions</b>
					<ul>
						<li>The client receives SLOTNUM == 0</li>
						<li>The client cannot proceed</li>
					</ul>
				</td>
			</tr>

			<tr>
				<td>
					<h4>testClientEnterRequestIndoorOccupied</h4>
					The client requests a slot but there the weightsensor still detects a car. (F1, F7)
					<br/><b>Conditions</b>
					<ul>
						<li>The ParkServiceGUI notifies the client to wait before entering</li>
					</ul>
				</td>
			</tr>

			<tr>
				<td>
					<h4>testClientEnterRequestStoppedTrolley</h4>
					The client makes an enter request, but the parking trolley is stopped. (F1, F7, F8)
					<br/><b>Conditions</b>
					<ul>
						<li>The system notifies the client the problem</li>
					</ul>
				</td>
			</tr>


			<!-- TEST CAR ENTER (F3, F5, F6, F8) -->

			<tr>
				<td>
					<h4>testClientCarEnter</h4>
					The client has received SLOTNUM between 1 and 6, left the car in front of the INDOOR-area and pressed
					CARENTER (F3, F5, F6)
					<br/><b>Conditions</b>
					<ul>
						<li>The client receives a unique tokenID</li>
						<li>The INDOOR-area is freed</li>
						<li>The selected parking slot become occupied</li>
					</ul>
				</td>
			</tr>

			<tr>
				<td>
					<h4>testClientCarEnterStoppedTrolley</h4>
					The client has received SLOTNUM between 1 and 6, left the car in front of the INDOOR-area and pressed
					CARENTER, but the parking trolley is stopped. (F3, F8)
					<br/><b>Conditions</b>
					<ul>
						<li>The system notifies the client the problem</li>
					</ul>
				</td>
			</tr>

			<tr>
				<td>
					<h4>testClientCarEnterIndoorNotOccupied</h4>
					The client has received SLOTNUM between 1 and 6 and pressed CARENTER, but didn't leave the car in
					front of the INDOOR-area. (F6)
					<br/><b>Conditions</b>
					<ul>
						<li>The ParkServiceGUI notifies the client the error</li>
					</ul>
				</td>
			</tr>


			<!-- TEST PICKUP (F9, F10, F11) -->

			<tr>
				<td>
					<h4>testClientPickup</h4>
					The client request to pick up his car by submitting the tokenID, and then leave. (F9, F10, F11)
					<br/><b>Conditions</b>
					<ul>
						<li>The tokenID is valid</li>
						<li>The selected parking slot become free</li>
						<li>The OUTDOOR-area must be freed within TMAX time</li> <!--più che altro controlliamo che dopo X time dia un evento, magari lo facciamo in un altro test-->
					</ul>
				</td>
			</tr>

			<tr>
				<td>
					<h4>testClientPickupOutdoorOccupied</h4>
					The client request to pick up his car by submitting a valid tokenID, but the OUTDOOR-area is occupied.
					(F9, F10, F11)
					<br/><b>Conditions</b>
					<ul>
						<li>The system notifies the client to wait</li>
					</ul>
				</td>
			</tr>

			<tr>
				<td>
					<h4>testClientPickupWrongToken</h4>
					The client request to pick up his car by submitting the tokenID, but the tokenID is not valid. (F9, F10, F11)
					<br/><b>Conditions</b>
					<ul>
						<li>The client receives an error from the system</li>
					</ul>
				</td>
			</tr>

			<tr>
				<td>
					<h4>testClientPickupStoppedTrolley</h4>
					The client request to pick up his car by submitting a valid tokenID, but the parking trolley is stopped.
					(F8, F9)
					<br/><b>Conditions</b>
					<ul>
						<li>The system notifies the client the problem</li>
					</ul>
				</td>
			</tr>

			<!-- TEST MANAGER (F12, F13, F14, F15, F16) -->

			<tr>
				<td>
					<h4>testTemperatureChangeFanOn</h4>
					The temperature goes over TMAX. (F15)
					<br/><b>Conditions</b>
					<ul>
						<li>The fan turns ON</li>
					</ul>
				</td>
			</tr>

			<tr>
				<td>
					<h4>testTemperatureChangeFanOff</h4>
					The temperature goes under TMAX. (F15)
					<br/><b>Conditions</b>
					<ul>
						<li>The fan turns OFF</li>
					</ul>
				</td>
			</tr>

			<tr>
				<td>
					<h4>testStopTrolley</h4>
					The parking manager requests to stop the trolley and the temperature is over TMAX. (F13)
					<br/><b>Conditions</b>
					<ul>
						<li>The trolley state becomes stopped (after it finish his current works)</li>
					</ul>
				</td>
			</tr>

			<tr>
				<td>
					<h4>testStopTrolleyTemperatureError</h4>
					The parking manager requests to stop the trolley but the temperature is not over TMAX. (F13)
					<br/><b>Conditions</b>
					<ul>
						<li>The system shows an error to the parking manager</li>
					</ul>
				</td>
			</tr>

			<tr>
				<td>
					<h4>testResumeTrolley</h4>
					The parking manager requests to resume the trolley. (F14)
					<br/><b>Conditions</b>
					<ul>
						<li>The trolley state becomes idle or working</li>
					</ul>
				</td>
			</tr>

		</table>
	</div>


	<h2>Work plan</h2>
	<div class="remark">
		We can assess the time needed to implement all the feature discussed above as follows:
		<ol>
			<li>Communication with devices (total 2 days)
				<ol>
					<li>Sonar: 3h</li>
					<li>Fan: 1h</li>
					<li>Thermometer: 2h</li>
					<li>Weight sensor: 2h</li>
					<li>Transport trolley: 1 day</li>
				</ol></li>
			<li>
				ParkManagerService core: 7 days
				<ol>
					<li>client logic: 4 days</li>
					<li>manager logic: 2 days</li>
					<li>tests: 1 day</li>
				</ol>
			</li>
			<li>API endpoints for 2 GUI: 8h</li>
			<li>ParkServiceGUI (total 10h)
				<ol>
					<li>Design (including choice of theme): 3h</li>
					<li>Realization (only client side): 7h</li>
				</ol>
			</li>
			<li>ParkServiceStatusGUI (total 7.5h)
				<ol>
					<li>Design (same theme of above): 1.5h</li>
					<li>Realization (only client side): 6h</li>
				</ol>
			</li>
		</ol>
		One day of work is equal to 8 working hours.<br>
		Total work estimate: 12 days and 1.5 hours.
	</div>

	<h2>Project</h2>
	<div class="remark">
		The project will be divided in sprint.<br>

		<ul>
			<li><a href="../../sprint1/userDocs/Sprint1.html">Sprint 1</a>, implementation of client logic</li>

			<li><a href="../../sprint2/userDocs/Sprint2.html">Sprint 2</a>, implementation of manager logic and
				client's and manager's GUI</li>

			<li><a href="../../sprint3/userDocs/Sprint3.html">Sprint 3</a>, implementation of trolley actions</li>

			 <li><a href="../../sprint4/userDocs/Sprint4.html">Sprint 4</a>, implementation of mocked sensors, logging</li>
		</ul>
	</div>

	<h2>Testing</h2>
	<div class="remark">
		In order to test the application, multiple test classes were written. Once written in a specific sprint, they
		were executed in following sprints in order to check that the functionalities were still working.
		<ol>
			<li>
				<k>TestDB</k>, tests the saving and retrieval of the informations to and from the database, working from sprint1.
				<ul>
					<li><a href="../../sprint1/test/eu/musarellatripi/test/TestDB.kt">Sprint 1</a></li>
					<li><a href="../../sprint2/core/test/eu/musarellatripi/test/TestDB.kt">Sprint 2</a></li>
					<li><a href="../../sprint3/core/test/eu/musarellatripi/test/TestDB.kt">Sprint 3</a></li>
					<li><a href="../../sprint4/core/test/eu/musarellatripi/test/TestDB.kt">Sprint 4</a></li>
				</ul>
			</li>
			<li>
				<k>TestPlan0</k>, tests the client logic, planned in sprint0, working from sprint1.
				<ul>
					<li><a href="../../sprint1/test/eu/musarellatripi/test/TestPlan0.kt">Sprint 1</a></li>
					<li><a href="../../sprint2/core/test/eu/musarellatripi/test/TestPlan0.kt">Sprint 2</a></li>
					<li><a href="../../sprint3/core/test/eu/musarellatripi/test/TestPlan0.kt">Sprint 3</a></li>
					<li><a href="../../sprint4/core/test/eu/musarellatripi/test/TestPlan0.kt">Sprint 4</a></li>
				</ul>
			</li>
			<li>
				<k>TestPlan2</k>, tests the manager logic, working from sprint2.
				<ul>
					<li><a href="../../sprint2/core/test/eu/musarellatripi/test/TestPlan2.kt">Sprint 2</a></li>
					<li><a href="../../sprint3/core/test/eu/musarellatripi/test/TestPlan2.kt">Sprint 3</a></li>
					<li><a href="../../sprint4/core/test/eu/musarellatripi/test/TestPlan2.kt">Sprint 4</a></li>
				</ul>
			</li>
			<li>
				<k>WebappApplicationTests</k>, tests the API functionalities, working from sprint2.
				<ul>
					<li><a href="../../sprint2/web/src/test/kotlin/eu/musarellatripi/webapp/WebappApplicationTests.kt">Sprint 2</a></li>
					<li><a href="../../sprint3/web/src/test/kotlin/eu/musarellatripi/webapp/WebappApplicationTests.kt">Sprint 3</a></li>
					<li><a href="../../sprint4/web/src/test/kotlin/eu/musarellatripi/webapp/WebappApplicationTests.kt">Sprint 4</a></li>
				</ul>
			</li>
		</ol>
	</div>

	<h2 id="deployment">Deployment</h2>
	<div class="remark">
		For deployment, as explained during sprint4, we used docker. In order to start the application, it is first necessary
		to go to the root folder and start the trolley and the basicrobot, with one of the following commands:
		<pre>docker-compose -f basicrobotVirtual.yaml up</pre>
		for the trolley in the virtual environment or
		<pre>docker-compose -f basicrobotMbot.yaml up</pre>
		for a real Mbot trolley.<br>
		After that, to start the application it is only necessary to run the following command:
		<pre>docker-compose -f ParkManagerService.yaml up</pre>
		<br>
		The web server listen for requests on port <a href="http://localhost:8081">8081</a>.
	</div>

	<h2>Maintenance</h2>
	<div class="remark">
		As for our organization for updates, exposed in a <a href="../../sprint4/userDocs/Sprint4.html#deploy">section of sprint4</a>, in order to update the project
		in docker it is necessary to push the changes to the master branch in github. The folders with the final code that
		have to be edited are <k>web</k>, <k>core</k> and <k>sensors</k>, located in the main folder.
	</div>
	<!-- USEFUL
	<table style="width:100%" border="1">
	<tr>
	<td style="width:50%">
	</td>
	<td></td>
	</tr>
	</table>
	-->

	<br/><br/>
</div>

<div style="background-color:rgba(86, 56, 253, 0.9); width:60%;text-align:left;color:white">
	By Alessandro Musarella <a style="color: white" href="mailto:alessandro.musarella@studio.unibo.it">alessandro.musarella@studio.unibo.it</a><br>
	By Giulio Tripi <a style="color: white" href="mailto:giulio.tripi@studio.unibo.it">giulio.tripi@studio.unibo.it</a><br>
	GitHub: <a style="color: white" href="https://github.com/giuliotripi/ParkManagerService">https://github.com/giuliotripi/ParkManagerService</a>
</div>

<script type="application/javascript">
    let functionalList = document.querySelectorAll('ol.functional.custom > li');
    for (let i = 0; i < functionalList.length; i++)
        functionalList[i].id = 'F' + (i+1);
    let nonfunctionalList = document.querySelectorAll('ol.nonfunctional.custom > li');
    for (let i = 0; i < nonfunctionalList.length; i++)
        nonfunctionalList[i].id = 'NF' + (i+1);
</script>

</body>
</html>